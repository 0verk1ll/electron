From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Andy Locascio <andy@slack-corp.com>
Date: Wed, 6 May 2020 16:37:54 -0700
Subject: allow in-process windows to have different web prefs

Allow earlier access to newly created WebContents so that we can change
WebPreferences of in-process child windows, rather than relying on
process-level command line switches, as before.

diff --git a/content/browser/web_contents/web_contents_impl.cc b/content/browser/web_contents/web_contents_impl.cc
index a5d5821b4de14533c286329639e3729de1e20c06..0485ab0df46f6f06c8abefb75058455b0694ca83 100644
--- a/content/browser/web_contents/web_contents_impl.cc
+++ b/content/browser/web_contents/web_contents_impl.cc
@@ -3056,6 +3056,10 @@ RenderFrameHostDelegate* WebContentsImpl::CreateNewWindow(
   }
   auto* new_contents_impl = new_contents.get();
 
+  if (delegate_) {
+    delegate_->WebContentsCreatedWithFullParams(this, render_process_id, opener->GetRoutingID(), params, new_contents_impl);
+  }
+
   new_contents_impl->GetController().SetSessionStorageNamespace(
       partition_id, session_storage_namespace);
 
@@ -3097,12 +3101,6 @@ RenderFrameHostDelegate* WebContentsImpl::CreateNewWindow(
     AddDestructionObserver(new_contents_impl);
   }
 
-  if (delegate_) {
-    delegate_->WebContentsCreatedWithFullParams(this, render_process_id,
-                                                opener->GetRoutingID(),
-                                                params, new_contents_impl);
-  }
-
   for (auto& observer : observers_) {
     observer.DidOpenRequestedURL(new_contents_impl, opener, params.target_url,
                                  params.referrer.To<Referrer>(),
diff --git a/content/public/common/common_param_traits_macros.h b/content/public/common/common_param_traits_macros.h
index a7f8944a9c763c226c5c18ba2bc0256143a21318..bf10bbf55428d45daee3ada8f0b3a5bde702b09f 100644
--- a/content/public/common/common_param_traits_macros.h
+++ b/content/public/common/common_param_traits_macros.h
@@ -132,6 +132,27 @@ IPC_STRUCT_TRAITS_BEGIN(content::WebPreferences)
   IPC_STRUCT_TRAITS_MEMBER(webgl2_enabled)
   IPC_STRUCT_TRAITS_MEMBER(pepper_3d_enabled)
   IPC_STRUCT_TRAITS_MEMBER(record_whole_document)
+
+  IPC_STRUCT_TRAITS_MEMBER(preloads)
+  IPC_STRUCT_TRAITS_MEMBER(disable_electron_site_instance_overrides)
+  IPC_STRUCT_TRAITS_MEMBER(background_color)
+  IPC_STRUCT_TRAITS_MEMBER(opener_id)
+  IPC_STRUCT_TRAITS_MEMBER(context_isolation)
+  IPC_STRUCT_TRAITS_MEMBER(enable_remote_module)
+  IPC_STRUCT_TRAITS_MEMBER(guest_instance_id)
+  IPC_STRUCT_TRAITS_MEMBER(hidden_page)
+  IPC_STRUCT_TRAITS_MEMBER(offscreen)
+  IPC_STRUCT_TRAITS_MEMBER(preload)
+  IPC_STRUCT_TRAITS_MEMBER(native_window_open)
+  IPC_STRUCT_TRAITS_MEMBER(node_integration)
+  IPC_STRUCT_TRAITS_MEMBER(node_integration_in_worker)
+  IPC_STRUCT_TRAITS_MEMBER(node_leakage_in_renderers)
+  IPC_STRUCT_TRAITS_MEMBER(node_integration_in_sub_frames)
+  IPC_STRUCT_TRAITS_MEMBER(enable_spellcheck)
+  IPC_STRUCT_TRAITS_MEMBER(enable_plugins)
+  IPC_STRUCT_TRAITS_MEMBER(enable_websql)
+  IPC_STRUCT_TRAITS_MEMBER(webview_tag)
+
   IPC_STRUCT_TRAITS_MEMBER(flash_3d_enabled)
   IPC_STRUCT_TRAITS_MEMBER(flash_stage3d_enabled)
   IPC_STRUCT_TRAITS_MEMBER(flash_stage3d_baseline_enabled)
diff --git a/content/public/common/web_preferences.cc b/content/public/common/web_preferences.cc
index 0cc0c87e74e829e16fc9dd449bef33a7db5f6799..b06b0e6fcbcc908c851d21dcf46fb71c014e4410 100644
--- a/content/public/common/web_preferences.cc
+++ b/content/public/common/web_preferences.cc
@@ -177,6 +177,27 @@ WebPreferences::WebPreferences()
       navigate_on_drag_drop(true),
       v8_cache_options(blink::mojom::V8CacheOptions::kDefault),
       record_whole_document(false),
+
+      preloads(base::EmptyString()),
+      disable_electron_site_instance_overrides(),
+      background_color(base::EmptyString()),
+      opener_id(0),
+      context_isolation(false),
+      enable_remote_module(false),
+      guest_instance_id(0),
+      hidden_page(false),
+      offscreen(false),
+      preload(base::EmptyString()),
+      native_window_open(false),
+      node_integration(false),
+      node_integration_in_worker(false),
+      node_leakage_in_renderers(false),
+      node_integration_in_sub_frames(false),
+      enable_spellcheck(false),
+      enable_plugins(false),
+      enable_websql(false),
+      webview_tag(false),
+
       cookie_enabled(true),
       accelerated_video_decode_enabled(false),
       animation_policy(IMAGE_ANIMATION_POLICY_ALLOWED),
diff --git a/content/public/common/web_preferences.h b/content/public/common/web_preferences.h
index e2183b7525eb21349b5de82512d8b9858ba2e743..7072e334c5dc7c75a25119d5c1b6a793abe7285a 100644
--- a/content/public/common/web_preferences.h
+++ b/content/public/common/web_preferences.h
@@ -183,6 +183,26 @@ struct CONTENT_EXPORT WebPreferences {
   blink::mojom::V8CacheOptions v8_cache_options;
   bool record_whole_document;
 
+  std::string preloads;
+  bool disable_electron_site_instance_overrides;
+  std::string background_color;
+  int opener_id;
+  bool context_isolation;
+  bool enable_remote_module;
+  int guest_instance_id;
+  bool hidden_page;
+  bool offscreen;
+  std::string preload;
+  bool native_window_open;
+  bool node_integration;
+  bool node_integration_in_worker;
+  bool node_leakage_in_renderers;
+  bool node_integration_in_sub_frames;
+  bool enable_spellcheck;
+  bool enable_plugins;
+  bool enable_websql;
+  bool webview_tag;
+
   // This flags corresponds to a Page's Settings' setCookieEnabled state. It
   // only controls whether or not the "document.cookie" field is properly
   // connected to the backing store, for instance if you wanted to be able to
